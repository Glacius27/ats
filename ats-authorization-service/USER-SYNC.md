# Синхронизация пользователей из Keycloak

## Автоматическая синхронизация

Authorization service теперь автоматически синхронизирует пользователей из Keycloak:

1. **При первом входе**: Когда пользователь входит через Keycloak, и фронтенд запрашивает данные пользователя через `/api/users/by-keycloak-id/{keycloakUserId}`, если пользователь не найден в базе данных authorization service, он автоматически создается из данных Keycloak с синхронизацией ролей.

2. **Ручная синхронизация**: Можно вызвать endpoint для синхронизации всех пользователей из Keycloak:
   ```bash
   curl -X POST http://authorization.local/api/users/sync-from-keycloak
   ```

## Как это работает

1. При запросе пользователя по Keycloak ID:
   - Если пользователь найден в базе - возвращается его данные
   - Если не найден - запрашиваются данные из Keycloak, создается пользователь в базе, синхронизируются роли

2. При синхронизации всех пользователей:
   - Получается список всех пользователей из Keycloak
   - Для каждого пользователя:
     - Если пользователь не существует - создается новый
     - Если существует - обновляются данные (username, email, isActive)
     - Синхронизируются роли (добавляются новые, удаляются старые)

## Сравнение ролей

Роли сравниваются без учета регистра (case-insensitive), поэтому:
- Роль "recruiter" в Keycloak будет сопоставлена с ролью "Recruiter" в базе данных
- Роль "Recruiter" в Keycloak будет сопоставлена с ролью "recruiter" в базе данных

## Роли в базе данных

В базе данных должны существовать следующие роли (создаются через миграции):
- `Admin` или `admin`
- `Recruiter` или `recruiter`
- `Manager` или `manager`

## Пример использования

После импорта realm из `ats-realm.json` в Keycloak, пользователи автоматически появятся в authorization service при первом входе или при вызове endpoint синхронизации.

### Проверка синхронизации

```bash
# Синхронизировать всех пользователей
curl -X POST http://authorization.local/api/users/sync-from-keycloak

# Проверить пользователя
curl http://authorization.local/api/users/by-keycloak-id/{keycloakUserId}

# Список всех пользователей
curl http://authorization.local/api/users
```
